<html>
<head>
     <script type="text/javascript" src="http://lib.ivank.net/ivank.js"></script>
     <script type="text/javascript" src="Box2dWeb-2.1.a.3.min.js"></script>
     <script type="text/javascript" src="bundle.js"></script>
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css" />
	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>
	<script type="text/javascript" src="createstage.js"></script>
	<script type="text/javascript">
          var world;
          var bodies = [];	// instances of b2Body (from Box2D)
          var actors = [];	// instances of Bitmap (from IvanK)
          var SCALE = 100;

          function Start()
          {
               var stage = new Stage("c");
    			stage.addEventListener(Event.ENTER_FRAME, onEF);
				stage.addEventListener(MouseEvent.CLICK, Jump);
				stage.addEventListener(MouseEvent.MOUSE_MOVE, recoil);
               // background
				var bg = new Bitmap( new BitmapData("images.jpg") );
				bg.scaleX = stage.stageWidth/1024;
				bg.scaleY = stage.stageHeight/512;
				stage.addChild(bg);

				var	b2Vec2	= Box2D.Common.Math.b2Vec2,
				b2BodyDef	= Box2D.Dynamics.b2BodyDef,
				b2Body		= Box2D.Dynamics.b2Body,
				b2FixtureDef	= Box2D.Dynamics.b2FixtureDef,
				b2World		= Box2D.Dynamics.b2World,
				b2PolygonShape	= Box2D.Collision.Shapes.b2PolygonShape;
				b2CircleShape	= Box2D.Collision.Shapes.b2CircleShape;

				world = new b2World(new b2Vec2(0, 10),  true);

				// I decided that 1 meter = 100 pixels

				var bxFixDef	= new b2FixtureDef();	// box  fixture definition
				bxFixDef.shape	= new b2PolygonShape();
				var blFixDef	= new b2FixtureDef();	// ball fixture definition
				blFixDef.shape	= new b2CircleShape();
				bxFixDef.density	= blFixDef.density = 1;
				blFixDef.friction = 1;
				blFixDef.restitution = 0.3;

               var bodyDef = new b2BodyDef();
               bodyDef.type = b2Body.b2_staticBody;

               // create ground
               bxFixDef.shape.SetAsBox(10, 1);
               bodyDef.position.Set(stage.stageWidth/(SCALE*2), stage.stageHeight/SCALE + 1);
               world.CreateBody(bodyDef).CreateFixture(bxFixDef);

               bxFixDef.shape.SetAsBox(1, 100);

				// left wall
				bodyDef.position.Set(-1, 3);
				world.CreateBody(bodyDef).CreateFixture(bxFixDef);

				// right wall
				bodyDef.position.Set(stage.stageWidth/SCALE + 1, 3);
				world.CreateBody(bodyDef).CreateFixture(bxFixDef);


	             bodyDef.type = b2Body.b2_dynamicBody;

				// both images are 200 x 200 px
				var blBD = new BitmapData("img/cannonball.png");

				// let's add 25 boxes and 25 balls!
				var hw = 0.3;	// "half width"
				blFixDef.shape.SetRadius(hw);


               // right ball
               bodyDef.position.Set(stage.stageWidth/SCALE, stage.stageHeight/SCALE);

               var body = world.CreateBody(bodyDef);
               body.CreateFixture(blFixDef);	// ball
               bodies.push(body);

               var bm = new Bitmap(blBD);  bm.x = bm.y = -100; //Ball is of 200 x 200 pixels. That is why it is given half of the ball size.
               var actor = new Sprite();
               actor.addChild(bm);
               actor.scaleX = actor.scaleY = hw;

//               actor.addEventListener(MouseEvent.CLICK, Jump);
               stage.addChild(actor);
               actors.push(actor);


				bodyDef.position.Set(0, stage.stageHeight/(2*SCALE));
				bodyDef.type=b2Body.b2_kinematicBody;
				var fixtureDef = new b2FixtureDef();
				fixtureDef.shape = new b2PolygonShape();
				fixtureDef.shape.SetAsBox(hw,hw);
				var theKinematic = world.CreateBody(bodyDef);
				theKinematic.CreateFixture(fixtureDef);
//			    theKinematic.SetLinearVelocity(new b2Vec2(1,0));
	            bodies.push(theKinematic);

				var bxBD = new BitmapData("img/box.png");

				var bm = new Bitmap(bxBD);
				bm.x = bm.y = -100; //Ball is of 200 x 200 pixels. That is why it is given half of the ball size.
				var actor = new Sprite();
				actor.addChild(bm);
				actor.scaleX = actor.scaleY = hw;

//				actor.addEventListener(MouseEvent.CLICK, recoil);
				stage.addChild(actor);
				actors.push(actor);

          }

			function onEF(e)
			{
				world.Step(1 / 60,  10,  3);
               world.ClearForces();

               for(var i=0; i<actors.length; i++)
               {
                    var body  = bodies[i];
                    var actor = actors [i];
                    var p = body.GetPosition();
                    actor.x = p.x *SCALE;	// updating actor
                    actor.y = p.y *SCALE;
                    actor.rotation = body.GetAngle()*180/Math.PI;
				}
			}

			function Jump(e)
			{
		//		alert(read.readFile());
				for(var i=0; i<bodies.length; i++)
				{
					var impulse = getImpulse(e, bodies[i]);
					bodies[i].ApplyImpulse(impulse, bodies[i].GetWorldCenter());
				}
          	}

          	function recoil(e)
          	{
				var currentTarget = e.currentTarget;

				var cursorX = currentTarget.mouseX/SCALE;
				var cursorY = currentTarget.mouseY/SCALE;

				var body = bodies[1];
				var position = body.GetPosition();
				var bodyX = position.x;
				var bodyY = position.y;

				var dirX = -bodyX+cursorX;
				var dirY = -bodyY+cursorY;

				var angle = Math.atan(dirY/dirX);
				body.SetAngle(angle);

          	}

			function getImpulse(e, body)
			{
				var currentTarget = e.currentTarget;

				var cursorX = currentTarget.mouseX/SCALE;
				var cursorY = currentTarget.mouseY/SCALE;

				var position = body.GetPosition();
				var bodyX = position.x;
				var bodyY = position.y;

//				alert(bodyX+" "+bodyY+" "+cursorX+" "+cursorY+" "+currentTarget.stageWidth);

				var b2Vec2 = Box2D.Common.Math.b2Vec2;

				var impulseX = -bodyX+cursorX;
				var impulseY = -bodyY+cursorY;

				var impulseModulus = Math.sqrt(impulseX*impulseX + impulseY*impulseY);

				var impulse = new b2Vec2(impulseX, impulseY);

				return impulse;
			}

			function getRightBallVector(mouseX, mouseY)
			{

			}

			function getLeftBallVector(mouseX, mouseY)
			{

			}

     </script>
</head>
<body onload="Start();"><canvas id="c"></canvas></body>
</html>