<html>
<head>
    <script type="text/javascript" src="http://lib.ivank.net/ivank.js"></script>
    <script type="text/javascript" src="Box2dWeb-2.1.a.3.min.js"></script>
    <script type="text/javascript" src="bundle.js"></script>
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css" />
	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>
	<script type="text/javascript" src="createstage.js"></script>
	<script type="text/javascript">
		var world;
		var bodies = [];	// instances of b2Body (from Box2D)
		var actors = [];	// instances of Bitmap (from IvanK)
		var cannons = [];
		var cache = new Cache();
		var SCALE = 100;
		
		// Defined basic building components
		var b2Vec2	 = Box2D.Common.Math.b2Vec2;
		var b2BodyDef	 = Box2D.Dynamics.b2BodyDef;
		var b2Body	 = Box2D.Dynamics.b2Body;
		var b2FixtureDef = Box2D.Dynamics.b2FixtureDef;
		var b2World	 = Box2D.Dynamics.b2World;
		var b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape;
		var b2CircleShape	= Box2D.Collision.Shapes.b2CircleShape;
		  
		function Start()
        {
			var stage = new Stage("c");
			stage.addEventListener(Event.ENTER_FRAME, onEF);
			stage.addEventListener(MouseEvent.CLICK, Jump);
			stage.addEventListener(MouseEvent.MOUSE_MOVE, cannonfocus);
			stage.addEventListener(Event.ENTER_FRAME, recoil);
           
			// background
			var bg = new Bitmap( new BitmapData("images.jpg") );
			bg.scaleX = stage.stageWidth/1024;
			bg.scaleY = stage.stageHeight/512;
			stage.addChild(bg);

			world = new b2World(new b2Vec2(0, 10),  true);

			// I decided that 1 meter = 100 pixels

			var bxFixDef	= new b2FixtureDef();	// box  fixture definition
			bxFixDef.shape	= new b2PolygonShape();
			var blFixDef	= new b2FixtureDef();	// ball fixture definition
			blFixDef.shape	= new b2CircleShape();
			bxFixDef.density	= blFixDef.density = 1;
			blFixDef.friction = 1;
			blFixDef.restitution = 0.3;

			var bodyDef = new b2BodyDef();
			bodyDef.type = b2Body.b2_staticBody;

            // create ground
            bxFixDef.shape.SetAsBox(10, 1);
            bodyDef.position.Set(stage.stageWidth/(SCALE*2), stage.stageHeight/SCALE + 1);
            world.CreateBody(bodyDef).CreateFixture(bxFixDef);

			bxFixDef.shape.SetAsBox(1, 100);

			// left wall
			bodyDef.position.Set(-1, 3);
			world.CreateBody(bodyDef).CreateFixture(bxFixDef);

			// right wall
			bodyDef.position.Set(stage.stageWidth/SCALE + 1, 3);
			world.CreateBody(bodyDef).CreateFixture(bxFixDef);

			loadstage(stage, world);

		}

		function onEF(e)
		{
			world.Step(1 / 60,  10,  3);
			world.ClearForces();

			for(var i=0; i<actors.length; i++)
			{
				var body  = bodies[i];
				var actor = actors [i];
				var p = body.GetPosition();
				actor.x = p.x *SCALE;	// updating actor
                actor.y = p.y *SCALE;
                actor.rotation = body.GetAngle()*180/Math.PI;
			}
		}

			function Jump(e)
			{
				for(var i=0; i<bodies.length; i++)
				{
					var impulse = getImpulse(e, bodies[i]);
					bodies[i].ApplyImpulse(impulse, bodies[i].GetWorldCenter());
				}
          	}

			function getImpulse(e, body)
			{
				var currentTarget = e.currentTarget;


				var cursorX = currentTarget.mouseX/SCALE;
				var cursorY = currentTarget.mouseY/SCALE;

				var position = body.GetPosition();
				var bodyX = position.x;
				var bodyY = position.y;

//				alert(bodyX+" "+bodyY+" "+cursorX+" "+cursorY+" "+currentTarget.stageWidth);

				var b2Vec2 = Box2D.Common.Math.b2Vec2;

				var impulseX = -bodyX+cursorX;
				var impulseY = -bodyY+cursorY;

				var impulseModulus = Math.sqrt(impulseX*impulseX + impulseY*impulseY);

				var impulse = new b2Vec2(impulseX, impulseY);

				return impulse;
			}

          	function cannonfocus(e)
          	{
				var currentTarget = e.currentTarget;
				var cursorX = currentTarget.mouseX/SCALE;
				var cursorY = currentTarget.mouseY/SCALE;

				for(var i=0; i<cannons.length; i++)
				{
					var body = cannons[i];
					var position = body.GetPosition();
					var bodyX = position.x;
					var bodyY = position.y;

					var dirX = -bodyX+cursorX;
					var dirY = -bodyY+cursorY;

					var angle = Math.atan(dirY/dirX);
					body.SetAngle(angle-80);
				}
          	}
			
			function giverecoilImpulse(e)
			{
				var currentTarget = e.currentTarget;
				var cursorX = currentTarget.mouseX/SCALE;
				var cursorY = currentTarget.mouseY/SCALE;

				for(var i=0; i<cannons.length; i++)
				{
					var body = cannons[i];
					var position = body.GetPosition();
					var bodyX = position.x;
					var bodyY = position.y;

					var dirX = -bodyX+cursorX;
					var dirY = -bodyY+cursorY;
					
					if(i == 0)
					{
						cache.setItem("cannon1X",dirX);
						cache.setItem("cannon1Y",dirY);
					}
					else if(i == 1)
					{
						cache.setItem("cannon2X",dirX);
						cache.setItem("cannon2Y",dirY);
					}
					
					
					body.SetLinearVelocity(new b2Vec2(dirX,dirY))
					
					var angle = Math.atan(dirY/dirX);
					body.SetAngle(angle-80);
				}
			}
			
			function recoil(e)
			{
				if(cannons.length > 0)
				{
					if(cache.getItem("cannon1X") != null && cache.getItem("cannon1Y") != null)
					{
						var body = cannons[0];
						var position = body.GetPosition();
						var bodyX = position.x;
						var bodyY = position.y;

						var dirX = cache.getItem("cannon1X");
						var dirY = cache.getItem("cannon1Y");
						
						if(bodyX != dirX && bodyY != dirY)
						{
							var distance = Math.sqrt((bodyX-dirX)*(bodyX-dirX)+(bodyY-dirY)*(bodyY-dirY))
							if(distance >1)
							{
								var vel = body.GetLinearVelocity();
								vel.x = - vel.x;
								vel.y = - vel.y;
								
								if(distance < 0.05)
								{
									vel.x = 0;
									vel.y = 0;
									body.SetPosition(dirX, dirY);
								}
							}
						}
					}
				}
			}


     </script>
</head>
<body onload="Start();"><canvas id="c"></canvas></body>
</html>